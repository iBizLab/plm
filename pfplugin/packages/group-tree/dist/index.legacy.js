!function(){function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e,n,r){return t=y()?Reflect.construct.bind():function(e,t,n){var r=[null];r.push.apply(r,t);var o=new(Function.bind.apply(e,r));return n&&p(o,n.prototype),o},t.apply(null,arguments)}function n(e){return function(e){if(Array.isArray(e))return i(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||o(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=o(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,u=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return u=e.done,e},e:function(e){c=!0,a=e},f:function(){try{u||null==n.return||n.return()}finally{if(c)throw a}}}}function o(e,t){if(e){if("string"==typeof e)return i(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?i(e,t):void 0}}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function a(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */a=function(){return n};var t,n={},r=Object.prototype,o=r.hasOwnProperty,i=Object.defineProperty||function(e,t,n){e[t]=n.value},u="function"==typeof Symbol?Symbol:{},c=u.iterator||"@@iterator",l=u.asyncIterator||"@@asyncIterator",s=u.toStringTag||"@@toStringTag";function d(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{d({},"")}catch(t){d=function(e,t,n){return e[t]=n}}function f(e,t,n,r){var o=t&&t.prototype instanceof b?t:b,a=Object.create(o.prototype),u=new M(r||[]);return i(a,"_invoke",{value:T(e,n,u)}),a}function p(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}n.wrap=f;var h="suspendedStart",v="suspendedYield",y="executing",m="completed",g={};function b(){}function x(){}function w(){}var N={};d(N,c,(function(){return this}));var _=Object.getPrototypeOf,D=_&&_(_(R([])));D&&D!==r&&o.call(D,c)&&(N=D);var E=w.prototype=b.prototype=Object.create(N);function k(e){["next","throw","return"].forEach((function(t){d(e,t,(function(e){return this._invoke(t,e)}))}))}function I(t,n){function r(i,a,u,c){var l=p(t[i],t,a);if("throw"!==l.type){var s=l.arg,d=s.value;return d&&"object"==e(d)&&o.call(d,"__await")?n.resolve(d.__await).then((function(e){r("next",e,u,c)}),(function(e){r("throw",e,u,c)})):n.resolve(d).then((function(e){s.value=e,u(s)}),(function(e){return r("throw",e,u,c)}))}c(l.arg)}var a;i(this,"_invoke",{value:function(e,t){function o(){return new n((function(n,o){r(e,t,n,o)}))}return a=a?a.then(o,o):o()}})}function T(e,n,r){var o=h;return function(i,a){if(o===y)throw new Error("Generator is already running");if(o===m){if("throw"===i)throw a;return{value:t,done:!0}}for(r.method=i,r.arg=a;;){var u=r.delegate;if(u){var c=C(u,r);if(c){if(c===g)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===h)throw o=m,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=y;var l=p(e,n,r);if("normal"===l.type){if(o=r.done?m:v,l.arg===g)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=m,r.method="throw",r.arg=l.arg)}}}function C(e,n){var r=n.method,o=e.iterator[r];if(o===t)return n.delegate=null,"throw"===r&&e.iterator.return&&(n.method="return",n.arg=t,C(e,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var i=p(o,e.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,g;var a=i.arg;return a?a.done?(n[e.resultName]=a.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,g):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function S(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function M(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(S,this),this.reset(!0)}function R(n){if(n||""===n){var r=n[c];if(r)return r.call(n);if("function"==typeof n.next)return n;if(!isNaN(n.length)){var i=-1,a=function e(){for(;++i<n.length;)if(o.call(n,i))return e.value=n[i],e.done=!1,e;return e.value=t,e.done=!0,e};return a.next=a}}throw new TypeError(e(n)+" is not iterable")}return x.prototype=w,i(E,"constructor",{value:w,configurable:!0}),i(w,"constructor",{value:x,configurable:!0}),x.displayName=d(w,s,"GeneratorFunction"),n.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===x||"GeneratorFunction"===(t.displayName||t.name))},n.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,w):(e.__proto__=w,d(e,s,"GeneratorFunction")),e.prototype=Object.create(E),e},n.awrap=function(e){return{__await:e}},k(I.prototype),d(I.prototype,l,(function(){return this})),n.AsyncIterator=I,n.async=function(e,t,r,o,i){void 0===i&&(i=Promise);var a=new I(f(e,t,r,o),i);return n.isGeneratorFunction(t)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},k(E),d(E,s,"Generator"),d(E,c,(function(){return this})),d(E,"toString",(function(){return"[object Generator]"})),n.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},n.values=R,M.prototype={constructor:M,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(O),!e)for(var n in this)"t"===n.charAt(0)&&o.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function r(r,o){return u.type="throw",u.arg=e,n.next=r,o&&(n.method="next",n.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],u=a.completion;if("root"===a.tryLoc)return r("end");if(a.tryLoc<=this.prev){var c=o.call(a,"catchLoc"),l=o.call(a,"finallyLoc");if(c&&l){if(this.prev<a.catchLoc)return r(a.catchLoc,!0);if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return r(a.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return r(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&o.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),O(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;O(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={iterator:R(e),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=t),g}},n}function u(e,t,n,r,o,i,a){try{var u=e[i](a),c=u.value}catch(l){return void n(l)}u.done?t(c):Promise.resolve(c).then(r,o)}function c(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function a(e){u(i,r,o,a,c,"next",e)}function c(e){u(i,r,o,a,c,"throw",e)}a(void 0)}))}}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,b(r.key),r)}}function d(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function f(){return f="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=m(e)););return e}(e,t);if(r){var o=Object.getOwnPropertyDescriptor(r,t);return o.get?o.get.call(arguments.length<3?e:n):o.value}},f.apply(this,arguments)}function p(e,t){return p=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},p(e,t)}function h(t){var n=y();return function(){var r,o=m(t);if(n){var i=m(this).constructor;r=Reflect.construct(o,arguments,i)}else r=o.apply(this,arguments);return function(t,n){if(n&&("object"===e(n)||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return v(t)}(this,r)}}function v(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function y(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function m(e){return m=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},m(e)}function g(e,t,n){return(t=b(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function b(t){var n=function(t,n){if("object"!==e(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var o=r.call(t,n||"default");if("object"!==e(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(t)}(t,"string");return"symbol"===e(n)?n:String(n)}System.register(["@ibiz-template/runtime","@ibiz-template/vue3-util","vue","qx-util","lodash-es","@ibiz-template/core","ramda"],(function(e,o){"use strict";var i,u,s,y,b,x,w,N,_,D,E,k,I,T,C,S,O,M,R,j,L,A,P,K,B,F,z,V,U;return{setters:[function(e){i=e.TreeController,u=e.getChildNodeRSs,s=e.calcDeCodeNameById,y=e.handleAllSettled,b=e.Srfuf,x=e.getControlPanel,w=e.registerControlProvider},function(e){N=e.useControlController,_=e.useNamespace,D=e.withInstall},function(e){E=e.ref,k=e.defineComponent,I=e.computed,T=e.reactive,C=e.watch,S=e.nextTick,O=e.resolveComponent,M=e.onMounted,R=e.onUnmounted,j=e.withDirectives,L=e.createVNode,A=e.resolveDirective,P=e.isVNode,K=e.createTextVNode},function(e){B=e.createUUID},function(e){F=e.debounce},function(e){z=e.RuntimeError,V=e.RuntimeModelError},function(e){U=e.isNil}],execute:function(){function G(e,t){var n=t.state.items.find((function(t){return t._id===e}));return n||t.state.items.find((function(t){return t._uuid===e}))}var q=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&p(e,t)}(C,e);var t,o,i,x,w,N,_,D,k,I,T=h(C);function C(){var e;l(this,C);for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return g(v(e=T.call.apply(T,[this].concat(n))),"bottomToolbar",void 0),g(v(e),"hiddenNodeId",""),g(v(e),"renderMode","tree"),g(v(e),"isFilter",E(!1)),e}return d(C,[{key:"onCreated",value:(I=c(a().mark((function e(){var t,n,r,o;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,f(m(C.prototype),"onCreated",this).call(this);case 2:n=(null===(t=this.view.model.viewLayoutPanel)||void 0===t?void 0:t.controls)||[],this.bottomToolbar=n.find((function(e){return"toolbar"===e.name})),r=this.model.controlParam.ctrlParams,(o=void 0===r?{}:r).HIDDENNODEID&&(this.hiddenNodeId=o.HIDDENNODEID),o.RENDERMODE&&(this.renderMode=o.RENDERMODE);case 7:case"end":return e.stop()}}),e,this)}))),function(){return I.apply(this,arguments)})},{key:"initState",value:function(){f(m(C.prototype),"initState",this).call(this),this.state.newingNodeModel=null,this.state.newingNodeText=null,this.state.newingNodeDefault=null,this.state.editingNodeKey=null,this.state.editingNodeText=null,this.state.editingNodeDefault=null}},{key:"onDataChange",value:function(e){}},{key:"initDropNodeRss",value:function(){var e,t=this;null===(e=this.model.detreeNodes)||void 0===e||e.forEach((function(e){if(e.allowDrop){var n=[];u(t.model,{parentId:e.id,hasQuery:!1}).forEach((function(e){var r;if(null!==(r=e.parentDER1N)&&void 0!==r&&r.pickupDEFName){var o=t.getNodeModel(e.childDETreeNodeId);"DE"===(null==o?void 0:o.treeNodeType)&&o.appDataEntityId&&n.push({minorEntityId:o.appDataEntityId,pickupDEFName:e.parentDER1N.pickupDEFName.toLowerCase(),childDETreeNodeId:e.childDETreeNodeId,detreeNodeRSParams:e.detreeNodeRSParams})}})),n.length>0&&t.dropNodeRss.set(e.id,n)}}))}},{key:"updateTreeNode",value:function(e){var t=e.nodeKey,n=e.defaultValue,r=!(!0!==this.context.srfreadonly&&"true"!==this.context.srfreadonly);if(t&&t!==this.state.editingNodeKey&&!r){var o=G(t,this),i=this.getNodeModel(o._nodeId);null!=i&&i.allowEditText&&(this.state.editingNodeKey=o._id,this.state.editingNodeText=o._text,this.state.editingNodeDefault=n,this.state.newingNodeModel=null,this.state.newingNodeText=null,this.state.newingNodeDefault=null)}}},{key:"removeTreeNode",value:function(e){if(e&&e!==this.state.editingNodeKey){var t=G(e,this),n={context:this.context||{},params:this.params||{},data:[t]};this.onRemoveTreeNode(n)}}},{key:"newTreeNode",value:function(e){var t=e.nodeType,n=e.defaultValue,r=void 0===n?{}:n,o=this.getNodeModel(t);this.state.newingNodeModel=o,this.state.newingNodeDefault=r,this.state.editingNodeKey=null,this.state.editingNodeText=null,this.state.editingNodeDefault=null}},{key:"createDeNodeData",value:(k=c(a().mark((function e(t){var n,r=this;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=ibiz.hub.getApp(this.context.srfappid),e.next=3,Promise.all(t.map(function(){var e=c(a().mark((function e(t){var o,i,u,c;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=r.getNodeModel(t._nodeId),i=t._deData,u=r.context.clone(),e.next=5,n.deService.exec(o.appDataEntityId,"create",u,i);case 5:c=e.sent,r.emitDEDataChange("create",c.data),c.data&&r.refresh();case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return k.apply(this,arguments)})},{key:"onCreateTreeNode",value:(D=c(a().mark((function e(){var t,n,r,o,i;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.state.newingNodeModel,n=t.textAppDEFieldId,r=t.id,o=this.state.newingNodeText,i={_deData:{}},Object.assign(i,{_nodeId:r,_text:o}),Object.assign(i._deData,g({},n,o)),this.state.newingNodeDefault&&Object.assign(i._deData,this.state.newingNodeDefault),Object.assign(i._deData,g({},n,o)),e.next=9,this.createDeNodeData([i]);case 9:this.state.newingNodeModel=null,this.state.newingNodeText=null,this.state.newingNodeDefault=null;case 12:case"end":return e.stop()}}),e,this)}))),function(){return D.apply(this,arguments)})},{key:"onModifyTreeNode",value:(_=c(a().mark((function e(t,n){var r,o,i=this;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=this.getNodeModel(t._nodeId)).allowEditText){e.next=3;break}throw new V(r,"树节点没有配置编辑模式：名称");case 3:if("DE"===t._nodeType){e.next=5;break}throw new z("不是实体树节点数据");case 5:if(t._text===n){e.next=10;break}return t._text=n,this.state.editingNodeDefault&&(o=Object.keys(this.state.editingNodeDefault))&&o.length>0&&o.forEach((function(e){U(t._deData[e])&&(t._deData[e]=i.state.editingNodeDefault[e])})),e.next=10,this.updateDeNodeData([t]);case 10:this.state.editingNodeKey=null,this.state.editingNodeText=null,this.state.editingNodeDefault=null;case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return _.apply(this,arguments)})},{key:"onRemoveTreeNode",value:(N=c(a().mark((function e(t){var n,r,o,i,u,l,d,f=this;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.handlerAbilityParams(t),r=n.context,o=n.params,i=n.data,u=this.getNodeModel(i[0]._nodeId),!0===(null==t?void 0:t.silent)){e.next=8;break}return e.next=5,ibiz.confirm.error({title:"数据删除",desc:"确认删除数据？"});case 5:if(e.sent){e.next=8;break}return e.abrupt("return");case 8:return e.next=10,this._evt.emit("onBeforeRemove",void 0);case 10:return e.next=12,this.startLoading();case 12:return l=!1,e.prev=13,d=s(u.appDataEntityId),e.next=17,y(i.map(function(){var e=c(a().mark((function e(t){var n;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.srfuf===b.CREATE){e.next=8;break}return(n=r.clone())[d]=t.srfkey,e.next=5,ibiz.hub.getApp(u.appId).deService.exec(u.appDataEntityId,"remove",n,i,o);case 5:return e.next=7,e.sent;case 7:l=!0;case 8:f.afterRemove(t);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 17:if(!0!==(null==t?void 0:t.silent)&&this.actionNotification("REMOVESUCCESS",{data:i,default:"数据[".concat(i.map((function(e){return e.srfmajortext})).join("、"),"]删除成功!")}),!l||null!=t&&t.notRefresh){e.next=21;break}return e.next=21,this.refresh();case 21:e.next=29;break;case 23:return e.prev=23,e.t0=e.catch(13),e.next=27,this._evt.emit("onRemoveError",void 0);case 27:throw this.actionNotification("REMOVEERROR",{error:e.t0,data:i}),e.t0;case 29:return e.prev=29,e.next=32,this.endLoading();case 32:return e.finish(29);case 33:return this.state.selectedData=[],e.next=36,this._evt.emit("onRemoveSuccess",void 0);case 36:case"end":return e.stop()}}),e,this,[[13,23,29,33]])}))),function(e){return N.apply(this,arguments)})},{key:"calcAllowDrop",value:function(e,t,n){var r,o,i=this.getNodeModel(e._nodeId),a=this.getNodeModel(t._nodeId);if("inner"===n)return!!this.findDropNodeRS(t._nodeId,i.appDataEntityId);if(i.appDataEntityId!==a.appDataEntityId)return!1;if((null===(r=e._parent)||void 0===r?void 0:r._id)===(null===(o=t._parent)||void 0===o?void 0:o._id)){var u=this.getNodeModel(t._nodeId);return!0===(null==u?void 0:u.allowOrder)}if(!t._parent)return!1;if(t._parent&&t._parent._id&&this.getNodeModel(t._parent._nodeId).rootNode)return!0;return!!this.findDropNodeRS(t._parent._nodeId,i.appDataEntityId)}},{key:"onNodeDrop",value:(w=c(a().mark((function e(t,o,i){var u,c,l,d,f,p,h,v,y,m,g,b,x,w,N,_,D,E,k,I;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("inner"!==i||o._leaf||void 0!==o._children){e.next=3;break}return e.next=3,this.expandNodeByKey([o._id]);case 3:if(l=this.getNodeModel(t._nodeId),d="inner"===i?o:o._parent,f="inner"===i||(null===(u=o._parent)||void 0===u?void 0:u._id)!==(null===(c=t._parent)||void 0===c?void 0:c._id),p=this.getNodeModel(o._nodeId),h=l.appDataEntityId!==p.appDataEntityId,v=!1,this.getNodeModel(d._nodeId).rootNode&&(v=!0),!f&&!v){e.next=19;break}y=[],m=r(this.dropNodeRss.values());try{for(m.s();!(g=m.n()).done;)b=g.value,y.push.apply(y,n(b.filter((function(e){return e.minorEntityId===l.appDataEntityId}))))}catch(a){m.e(a)}finally{m.f()}return v&&f?y&&(y.forEach((function(e){t._deData[e.pickupDEFName]=null})),p=this.getNodeModel(l.id)):(x=this.findDropNodeRS(d._nodeId,l.appDataEntityId))&&(y&&y.forEach((function(e){t._deData[e.pickupDEFName]=null})),t._deData[x.pickupDEFName]=d._value,x.detreeNodeRSParams&&x.detreeNodeRSParams.forEach((function(e){var n,r;e.name&&e.value&&null!==(n=t._deData)&&void 0!==n&&n.hasOwnProperty(e.name.toLowerCase())&&null!==(r=d._deData)&&void 0!==r&&r.hasOwnProperty(e.value.toLowerCase())&&(t._deData[e.name.toLowerCase()]=d._deData[e.value.toLowerCase()])})),p=this.getNodeModel(x.childDETreeNodeId)),this.state.expandedKeys=this.calcExpandedKeys([d]),e.next=19,this.updateDeNodeData([t]);case 19:if("inner"!==i&&!h){e.next=27;break}if(!f){e.next=23;break}return e.next=23,this.refreshNodeChildren(t,!0);case 23:return e.next=25,this.refreshNodeChildren(d,!0);case 25:e.next=46;break;case 27:if(N=(w=p).moveAppDEActionId,_=w.appDataEntityId,!w.allowOrder){e.next=46;break}if(N){e.next=31;break}throw new V(this.model,ibiz.i18n.t("runtime.controller.common.md.noMoveDataCconfig"));case 31:return D={srftargetkey:o.srfkey,srfmovetype:"prev"===i?"MOVEBEFORE":"MOVEAFTER"},E=ibiz.hub.getApp(this.context.srfappid),k=s(_),(I=this.context.clone())[k]=t.srfkey,e.next=38,E.deService.exec(_,N,I,D);case 38:if(!e.sent.ok){e.next=46;break}if(this.emitDEDataChange("update",t._deData),!f){e.next=44;break}return e.next=44,this.refreshNodeChildren(t,!0);case 44:return e.next=46,this.refreshNodeChildren(d);case 46:this.state.selectedData=[];case 47:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return w.apply(this,arguments)})},{key:"onDEDataChange",value:function(e){var t=this;if(e.triggerKey!==this.triggerKey){var n=e.data;if("OBJECTCREATED"!==e.subtype){var r=this.state.items.find((function(e){return"DE"===e._nodeType&&e._deData&&e._deData.srfdecodename===n.srfdecodename&&e._deData.srfkey===n.srfkey}));r&&this.doNextActive((function(){return t.refreshNodeChildren(r,!0)}),{key:"refresh".concat(r._id)})}else{var o;(null===(o=this.model.detreeNodes)||void 0===o?void 0:o.find((function(e){if(e.appDataEntityId){var t=s(e.appDataEntityId);if(n.srfdecodename===t)return!0}return!1})))&&this.refresh()}}}},{key:"afterLoad",value:(x=c(a().mark((function e(t,n){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",f(m(C.prototype),"afterLoad",this).call(this,t,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return x.apply(this,arguments)})},{key:"onTreeNodeClick",value:(i=c(a().mark((function e(t,n){var r,o,i;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(o=null===(r=this.contextMenuInfos[t._nodeId])||void 0===r?void 0:r.clickTBUIActionItem)){e.next=3;break}return e.abrupt("return",this.doUIAction(o.uiactionId,t,n,o.appId));case 3:if(!this.state.navigational){e.next=7;break}if(null!=(i=this.getNodeModel(t._nodeId))&&i.navAppViewId){e.next=7;break}return e.abrupt("return");case 7:if(this.state.singleSelect&&!t._disableSelect&&this.setSelection([t]),1!==this.state.mdctrlActiveMode){e.next=11;break}return e.next=11,this.setActive(t);case 11:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"changeTreeState",value:(o=c(a().mark((function e(t){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t&&"draft"===t?(this.isFilter.value=!0,this.evt.emit("onFilterNode",{nodeTag:t})):this.resetTreeState();case 1:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"resetTreeState",value:function(){this.isFilter.value&&(this.evt.emit("onResetSate",{}),this.isFilter.value=!1)}},{key:"refresh",value:(t=c(a().mark((function e(){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:f(m(C.prototype),"refresh",this).call(this),this.resetTreeState();case 2:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),C}(i);var H=k({name:"IBizGroupTreeControl",props:{modelData:{type:Object,required:!0},context:{type:Object,required:!0},params:{type:Object,default:function(){return{}}},provider:{type:Object},mdctrlActiveMode:{type:Number,default:void 0},singleSelect:{type:Boolean,default:void 0},navigational:{type:Boolean,default:void 0},defaultExpandedKeys:{type:Array},loadDefault:{type:Boolean,default:!0}},setup:function(){var e=N((function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return t(q,n)})),n=I((function(){return!(!0!==e.context.srfreadonly&&"true"!==e.context.srfreadonly)})),r=T({});e.evt.on("onCreated",(function(){e.counter&&e.counter.onChange((function(e){Object.assign(r,e)}),!0)}));var i=_("control-group-tree"),u=_("control-".concat(e.model.controlType.toLowerCase())),l=E(null),s=E(null),d=E(""),f=E(null);C((function(){return f.value}),(function(e){e&&e.$el.getElementsByTagName("input")[0].focus()}));var p=function(){var t=c(a().mark((function t(){var n;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.state.editingNodeKey){t.next=8;break}if(!e.state.editingNodeText){t.next=7;break}return n=G(e.state.editingNodeKey,e),t.next=5,e.onModifyTreeNode(n,e.state.editingNodeText);case 5:t.next=8;break;case 7:e.state.editingNodeKey=null;case 8:e.state.newingNodeText?e.onCreateTreeNode():e.state.newingNodeModel=null;case 9:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),h=function(){var t=c(a().mark((function t(){return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.state.editingNodeKey&&(e.state.editingNodeKey=null),e.state.newingNodeModel&&(e.state.newingNodeModel=null,e.state.newingNodeText="");case 2:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),v=function(e,t){var n=function(){var t=e.value;if(!t)throw new z("找不到el-tree实例对象");return t},r=F((function n(){var r,o=e.value;o?(Object.values(o.store.nodesMap).forEach((function(e){var n=t.state.expandedKeys.includes(e.data._id);n!==e.expanded&&(n?e.expand():e.collapse())})),t.state.singleSelect?e.value.setCurrentKey((null===(r=t.state.selectedData[0])||void 0===r?void 0:r._id)||void 0):o.setCheckedKeys(t.state.selectedData.map((function(e){return e._id})))):setTimeout((function(){n()}),200)}),500);return{getTreeInstance:n,updateUI:r,triggerNodeExpand:function(e){var t=n(),r=null==t?void 0:t.store.nodesMap[e];if(r)return r.expanded?(r.collapse(),!1):(r.expand(),!0)}}}(l,e),y=v.updateUI,m=v.triggerNodeExpand,g=function(e){return e.map((function(e){return{_id:e._id,_uuid:e._uuid,_leaf:e._leaf,_text:e._text}}))};e.evt.on("onAfterRefreshParent",(function(e){if(l.value){var t=e.parentNode,n=e.children,r=g(n);l.value.updateKeyChildren(t._id,r),y()}})),e.evt.on("onAfterNodeDrop",(function(e){e.isChangedParent&&(d.value=B())}));var b=I((function(){return e.state.isLoaded?e.model.rootVisible?e.state.rootNodes:e.state.rootNodes.reduce((function(e,t){return t._children?e.concat(t._children):e}),[]):[]}));C(b,(function(e,t){e!==t&&(d.value=B())}));var w=function(){var t=c(a().mark((function t(n,r){var o,i;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==n.level){t.next=5;break}o=b.value,ibiz.log.debug("初始加载"),t.next=15;break;case 5:if(!(i=G(n.data._uuid,e))._children){t.next=11;break}ibiz.log.debug("节点展开加载-本地",i),o=i._children,t.next=15;break;case 11:return ibiz.log.debug("节点展开加载-远程",i),t.next=14,e.loadNodes(i);case 14:o=t.sent;case 15:ibiz.log.debug("给树返回值",o),r(g(o)),y();case 18:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}(),D=!1;e.evt.on("onLoadSuccess",(function(){D=!0,setTimeout((function(){D=!1}),200)})),e.evt.on("onSelectionChange",c(a().mark((function t(){var n;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!D){t.next=3;break}return t.next=3,S();case 3:e.state.singleSelect?l.value.setCurrentKey((null===(n=e.state.selectedData[0])||void 0===n?void 0:n._id)||void 0):l.value.setCheckedKeys(e.state.selectedData.map((function(e){return e._id})));case 4:case"end":return t.stop()}}),t)}))));var k,j=function(t,n){var r=n.checkedNodes;e.setSelection(r)},A=!1,P=function(t,r){var o;if(r.stopPropagation(),!t._disableSelect&&!A){if((null===(o=l.value)||void 0===o?void 0:o.getCurrentKey())===t._id&&!n.value){var i,a=null===(i=l.value)||void 0===i?void 0:i.getCurrentKey();e.updateTreeNode({nodeKey:a,defaultValue:{}})}var u;if(!e.state.singleSelect)null===(u=l.value)||void 0===u||u.setCurrentKey(t._id);if(e.state.navigational){var c=e.getNodeModel(t._nodeId);if(null==c||!c.navAppViewId){var s=m(t._id);e.onExpandChange(t,s)}}e.onTreeNodeClick(t,r),A=!0,setTimeout((function(){A=!1}),200)}},V=function(t,n){n.stopPropagation(),t._disableSelect||e.onDbTreeNodeClick(t)};e.evt.on("onMounted",(function(){if(Object.values(e.contextMenus).length>0){o.import("@imengyu/vue3-context-menu").then((function(e){(k=e.default).default&&!k.showContextMenu&&(k=k.default)}))}}));var H=O("IBizRawItem"),$=O("IBizIcon"),Q=function t(n,r,o,i){var a=[];return n.forEach((function(n){if("SEPERATOR"!==n.itemType){var u=i[n.id];if((!u||u.visible)&&!(n.actionLevel>100)){var c={};if(n.showCaption&&n.caption&&(c.label=n.caption),n.sysImage&&n.showIcon&&(c.icon=L($,{icon:n.sysImage},null)),"DEUIACTION"===n.itemType){c.disabled=u.disabled,c.clickClose=!0;var l=n.uiactionId;l&&(c.onClick=function(){e.doUIAction(l,r,o,n.appId)})}else if("RAWITEM"===n.itemType){n.rawItem&&(c.label=L(H,{rawItem:n},null))}else if("ITEMS"===n.itemType){var s;null!==(s=n.detoolbarItems)&&void 0!==s&&s.length&&(c.children=t(n.detoolbarItems,r,o,i))}a.push(c)}}else a.push({divided:"self"})})),a},Y=function(){var t=c(a().mark((function t(n,r){var o,u,c,l;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r.preventDefault(),r.stopPropagation(),null!=(o=e.getNodeModel(n._nodeId))&&o.decontextMenu){t.next=5;break}return t.abrupt("return");case 5:if((u=e.contextMenus[o.decontextMenu.id]).model.detoolbarItems){t.next=8;break}return t.abrupt("return");case 8:return t.next=10,u.calcButtonState(n._deData||(n.srfkey?n:void 0),o.appDataEntityId);case 10:if(c=u.state.buttonsState,(l=Q(u.model.detoolbarItems,n,r,c)).length){t.next=14;break}return t.abrupt("return");case 14:k.showContextMenu({x:r.x,y:r.y,customClass:i.b("context-menu"),items:l});case 15:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}(),J=function(t,n){var r;if(null!=t&&null!==(r=t.decontextMenu)&&void 0!==r&&null!==(r=r.detoolbarItems)&&void 0!==r&&r.length){var o=e.contextMenuInfos[t.id];return o.clickTBUIActionItem&&o.onlyOneActionItem?null:L(O("iBizContextMenuControl"),{modelData:t.decontextMenu,groupLevelKeys:[50,100],nodeModel:t,nodeData:n,context:e.context,onActionClick:function(t,r){return e.doUIAction(t.uiactionId,n,r,t.appId)}},null)}},W=function(t,n){var r=G(t._uuid,e);if(!r)throw new z("没有找到_uuid为".concat(t._uuid,"的节点"));e.onExpandChange(r,n)},X=F((function(){e.load()}),500),Z=function(t,n,r){var o=G(t.data._uuid,e),i=G(n.data._uuid,e);return e.calcAllowDrop(o,i,r)},ee=function(t){var n=G(t.data._uuid,e);return e.calcAllowDrag(n)},te=function(t,n,r){var o=function(e){switch(e){case"inner":return"inner";case"before":return"prev";case"after":return"next";default:throw new z("暂不支持dropType:".concat(e))}}(r),i=G(t.data._uuid,e),a=G(n.data._uuid,e);e.onNodeDrop(i,a,o)},ne=function(e){"Enter"!==e.key&&13!==e.keyCode||(e.stopPropagation(),p()),"Escape"!==e.key&&27!==e.keyCode||(e.stopPropagation(),h())},re=function(t){if("F2"===t.code||"Enter"===t.code){var n,r=null===(n=l.value)||void 0===n?void 0:n.getCurrentKey();e.updateTreeNode(r)}},oe=function(){var t=c(a().mark((function t(){return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.evt.emit("onBack",{}),e.isFilter.value=!1,l.value&&l.value.filter("");case 3:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();M((function(){var t;null===(t=s.value)||void 0===t||t.$el.addEventListener("keydown",re),e.evt.on("onFilterNode",function(){var t=c(a().mark((function t(n){var r;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:(r=n.nodeTag)&&(e.isFilter.value=!0),l.value&&l.value.filter("".concat(r,"@"));case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),e.evt.on("onResetSate",c(a().mark((function t(){return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.evt.emit("onBack",{}),e.isFilter.value=!1,l.value&&l.value.filter("");case 3:case"end":return t.stop()}}),t)})))),e.evt.on("onLoadSuccess",(function(){e.isFilter.value?e.evt.emit("onFilterNode",{nodeTag:"draft"}):e.evt.emit("onResetSate",{})}))})),R((function(){var e;null===(e=s.value)||void 0===e||e.$el.removeEventListener("keydown",re)}));var ie=function(e,t){return(t._id||"").includes(e)},ae=function(e){return"root:draft_parent"===e._id?"draft_parent":null},ue=function(e){if(e.counterId){var t=r[e.counterId];return U(t)||1===e.counterMode&&0===t?null:L("div",{class:i.em("counter","box")},[L("span",{class:i.e("dot")},[K("·")]),L(O("iBizBadge"),{class:i.e("counter"),value:t},null)])}},ce=function(t){var n,r;if(!e.state.newingNodeModel)return null;var o=(e.state.newingNodeDefault||{}).parent_id;if(o){if(!t)return null;if((t||{})._value!==o)return null}return!o&&t?null:L("div",{class:[i.be("node","newing")]},[null!==(n=e.state.newingNodeModel)&&void 0!==n&&n.sysImage?L($,{class:i.be("node","icon"),icon:null===(r=e.state.newingNodeModel)||void 0===r?void 0:r.sysImage},null):null,L(O("el-input"),{modelValue:e.state.newingNodeText,"onUpdate:modelValue":function(t){return e.state.newingNodeText=t},ref:"treeNodeTextInputRef",class:i.b("editing-node"),onBlur:p,onKeydown:function(e){ne(e)}},null)])};return{c:e,ns:i,treeRef:l,treeviewRef:s,treeNodeTextInputRef:f,treeData:b,treeRefreshKey:d,findNodeData:G,handleEditKeyDown:ne,onCheck:j,onNodeClick:P,onNodeDbClick:V,onNodeContextmenu:Y,loadData:w,renderContextMenu:J,renderCounter:ue,updateNodeExpand:W,onInput:function(t){e.state.query=t,X()},allowDrop:Z,allowDrag:ee,handleDrop:te,onNodeTextEditBlur:p,renderTree:function(){return L("div",{class:[i.b("content"),i.is("filter",e.isFilter.value)]},[e.isFilter.value?L("div",{class:i.b("filter")},[L("div",{class:i.be("filter","header"),onClick:oe},[L(O("ion-icon"),{name:"arrow-back-outline"},null),K("返回")])]):null,L("div",{class:[i.b("tree-box"),i.is("filter",e.isFilter.value)]},[L(O("el-tree"),{ref:"treeRef",key:d.value,class:[u.b("tree"),i.is("list-tree","listTree"===e.renderMode)],"node-key":"_id","highlight-current":!0,"expand-on-click-node":!1,"auto-expand-parent":!1,"show-checkbox":!e.state.singleSelect,"check-strictly":!0,"default-expanded-keys":e.state.expandedKeys,props:{label:"_text",children:"_children",isLeaf:"_leaf",class:ae},lazy:!0,load:w,onCheck:j,onNodeExpand:function(e){W(e,!0)},onNodeCollapse:function(e){W(e,!1)},draggable:!n.value,"allow-drop":Z,"allow-drag":ee,onNodeDrop:te,"filter-node-method":ie},{default:function(t){var r,o=G(t.data._uuid,e);if(!o)return null;var a,u=e.getNodeModel(o._nodeId);if(e.state.editingNodeKey===o._id&&!n.value)return L("div",{class:[i.b("node"),null===(a=u.sysCss)||void 0===a?void 0:a.cssName]},[o._icon?L($,{class:i.be("node","icon"),icon:o._icon},null):null,L(O("el-input"),{modelValue:e.state.editingNodeText,"onUpdate:modelValue":function(t){return e.state.editingNodeText=t},ref:"treeNodeTextInputRef",class:i.b("editing-node"),onBlur:function(){p()},onKeydown:function(e){ne(e)}},null)]);var c,l=x(u);return c=l?L(O("iBizControlShell"),{data:o,modelData:l,context:e.context,params:e.params},null):[o._icon?L($,{class:i.be("node","icon"),icon:o._icon},null):null,o._textHtml?L("span",{class:i.be("node","label"),innerHTML:o._textHtml},null):L("span",{class:i.be("node","label")},[o._text])],[L("div",{onDblclick:function(e){return V(o,e)},onClick:function(e){return P(o,e)},onContextmenu:function(e){return Y(o,e)},class:[i.b("node"),i.is("hidden",Object.is(e.hiddenNodeId,o._nodeId)&&!e.isFilter.value),o._leaf?i.be("node","item"):i.be("node","group"),null===(r=u.sysCss)||void 0===r?void 0:r.cssName]},[c,ue(u),J(u,o)]),ce(o)]}}),ce()])])}}},render:function(){var e=this,t={searchbar:function(){return e.c.enableQuickSearch?L(O("el-input"),{"model-value":e.c.state.query,class:e.ns.b("quick-search"),placeholder:e.c.state.placeHolder,onInput:e.onInput},{prefix:function(){return L(O("ion-icon"),{class:e.ns.e("search-icon"),name:"search"},null)}}):null}};this.c.bottomToolbar&&(t.toolbar=function(){return L(O("iBizControlShell"),{modelData:e.c.bottomToolbar,context:e.c.context,params:e.c.params},null)});var n,r=this.c.controlPanel?"tree":"default";return t[r]=function(){if(e.c.state.isLoaded&&e.treeRefreshKey)return e.renderTree()},j(L(O("iBizControlBase"),{ref:"treeviewRef",controller:this.c},"function"==typeof(n=t)||"[object Object]"===Object.prototype.toString.call(n)&&!P(n)?t:{default:function(){return[t]}}),[[A("loading"),this.c.state.isLoading]])}}),$=d((function e(){l(this,e),g(this,"component","IBizGroupTreeControl")})),Q=D(H,(function(e){e.component(H.name,H),w("TREE_RENDER_GROUP_TREE",(function(){return new $}))}));e({IBizGroupTreeControl:Q,default:Q})}}}))}();
