!function(){function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(e){return function(e){if(Array.isArray(e))return o(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||r(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=r(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var o=0,i=function(){};return{s:i,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,u=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return u=e.done,e},e:function(e){c=!0,a=e},f:function(){try{u||null==n.return||n.return()}finally{if(c)throw a}}}}function r(e,t){if(e){if("string"==typeof e)return o(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?o(e,t):void 0}}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function i(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */i=function(){return n};var t,n={},r=Object.prototype,o=r.hasOwnProperty,a=Object.defineProperty||function(e,t,n){e[t]=n.value},u="function"==typeof Symbol?Symbol:{},c=u.iterator||"@@iterator",l=u.asyncIterator||"@@asyncIterator",s=u.toStringTag||"@@toStringTag";function d(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{d({},"")}catch(t){d=function(e,t,n){return e[t]=n}}function f(e,t,n,r){var o=t&&t.prototype instanceof b?t:b,i=Object.create(o.prototype),u=new M(r||[]);return a(i,"_invoke",{value:T(e,n,u)}),i}function p(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}n.wrap=f;var h="suspendedStart",v="suspendedYield",y="executing",m="completed",g={};function b(){}function x(){}function w(){}var N={};d(N,c,(function(){return this}));var _=Object.getPrototypeOf,D=_&&_(_(R([])));D&&D!==r&&o.call(D,c)&&(N=D);var E=w.prototype=b.prototype=Object.create(N);function k(e){["next","throw","return"].forEach((function(t){d(e,t,(function(e){return this._invoke(t,e)}))}))}function I(t,n){function r(i,a,u,c){var l=p(t[i],t,a);if("throw"!==l.type){var s=l.arg,d=s.value;return d&&"object"==e(d)&&o.call(d,"__await")?n.resolve(d.__await).then((function(e){r("next",e,u,c)}),(function(e){r("throw",e,u,c)})):n.resolve(d).then((function(e){s.value=e,u(s)}),(function(e){return r("throw",e,u,c)}))}c(l.arg)}var i;a(this,"_invoke",{value:function(e,t){function o(){return new n((function(n,o){r(e,t,n,o)}))}return i=i?i.then(o,o):o()}})}function T(e,n,r){var o=h;return function(i,a){if(o===y)throw Error("Generator is already running");if(o===m){if("throw"===i)throw a;return{value:t,done:!0}}for(r.method=i,r.arg=a;;){var u=r.delegate;if(u){var c=C(u,r);if(c){if(c===g)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===h)throw o=m,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=y;var l=p(e,n,r);if("normal"===l.type){if(o=r.done?m:v,l.arg===g)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=m,r.method="throw",r.arg=l.arg)}}}function C(e,n){var r=n.method,o=e.iterator[r];if(o===t)return n.delegate=null,"throw"===r&&e.iterator.return&&(n.method="return",n.arg=t,C(e,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var i=p(o,e.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,g;var a=i.arg;return a?a.done?(n[e.resultName]=a.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,g):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function S(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function M(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(S,this),this.reset(!0)}function R(n){if(n||""===n){var r=n[c];if(r)return r.call(n);if("function"==typeof n.next)return n;if(!isNaN(n.length)){var i=-1,a=function e(){for(;++i<n.length;)if(o.call(n,i))return e.value=n[i],e.done=!1,e;return e.value=t,e.done=!0,e};return a.next=a}}throw new TypeError(e(n)+" is not iterable")}return x.prototype=w,a(E,"constructor",{value:w,configurable:!0}),a(w,"constructor",{value:x,configurable:!0}),x.displayName=d(w,s,"GeneratorFunction"),n.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===x||"GeneratorFunction"===(t.displayName||t.name))},n.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,w):(e.__proto__=w,d(e,s,"GeneratorFunction")),e.prototype=Object.create(E),e},n.awrap=function(e){return{__await:e}},k(I.prototype),d(I.prototype,l,(function(){return this})),n.AsyncIterator=I,n.async=function(e,t,r,o,i){void 0===i&&(i=Promise);var a=new I(f(e,t,r,o),i);return n.isGeneratorFunction(t)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},k(E),d(E,s,"Generator"),d(E,c,(function(){return this})),d(E,"toString",(function(){return"[object Generator]"})),n.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},n.values=R,M.prototype={constructor:M,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(O),!e)for(var n in this)"t"===n.charAt(0)&&o.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function r(r,o){return u.type="throw",u.arg=e,n.next=r,o&&(n.method="next",n.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],u=a.completion;if("root"===a.tryLoc)return r("end");if(a.tryLoc<=this.prev){var c=o.call(a,"catchLoc"),l=o.call(a,"finallyLoc");if(c&&l){if(this.prev<a.catchLoc)return r(a.catchLoc,!0);if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return r(a.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return r(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&o.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),O(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;O(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={iterator:R(e),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=t),g}},n}function a(e,t,n,r,o,i,a){try{var u=e[i](a),c=u.value}catch(e){return void n(e)}u.done?t(c):Promise.resolve(c).then(r,o)}function u(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function u(e){a(i,r,o,u,c,"next",e)}function c(e){a(i,r,o,u,c,"throw",e)}u(void 0)}))}}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,g(r.key),r)}}function s(e,t,n){return t&&l(e.prototype,t),n&&l(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function d(t,n,r){return n=v(n),function(t,n){if(n&&("object"==e(n)||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(t)}(t,f()?Reflect.construct(n,r||[],v(t).constructor):n.apply(t,r))}function f(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(f=function(){return!!e})()}function p(e,t,n,r){var o=h(v(1&r?e.prototype:e),t,n);return 2&r&&"function"==typeof o?function(e){return o.apply(n,e)}:o}function h(){return h="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,n){var r=function(e,t){for(;!{}.hasOwnProperty.call(e,t)&&null!==(e=v(e)););return e}(e,t);if(r){var o=Object.getOwnPropertyDescriptor(r,t);return o.get?o.get.call(arguments.length<3?e:n):o.value}},h.apply(null,arguments)}function v(e){return v=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},v(e)}function y(e,t){return y=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},y(e,t)}function m(e,t,n){return(t=g(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function g(t){var n=function(t,n){if("object"!=e(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var o=r.call(t,n||"default");if("object"!=e(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(t)}(t,"string");return"symbol"==e(n)?n:n+""}System.register(["@ibiz-template/runtime","@ibiz-template/vue3-util","vue","qx-util","lodash-es","@ibiz-template/core","ramda"],(function(e,r){"use strict";var o,a,l,h,v,g,b,x,w,N,_,D,E,k,I,T,C,S,O,M,R,L,j,A,P,K,B,F,z;return{setters:[function(e){o=e.TreeController,a=e.getChildNodeRSs,l=e.calcDeCodeNameById,h=e.handleAllSettled,v=e.Srfuf,g=e.getControlPanel,b=e.registerControlProvider},function(e){x=e.useControlController,w=e.useNamespace,N=e.withInstall},function(e){_=e.ref,D=e.defineComponent,E=e.computed,k=e.reactive,I=e.watch,T=e.nextTick,C=e.resolveComponent,S=e.onMounted,O=e.onUnmounted,M=e.withDirectives,R=e.createVNode,L=e.resolveDirective,j=e.isVNode,A=e.createTextVNode},function(e){P=e.createUUID},function(e){K=e.debounce},function(e){B=e.RuntimeError,F=e.RuntimeModelError},function(e){z=e.isNil}],execute:function(){function V(e,t){var n=t.state.items.find((function(t){return t._id===e}));return n||t.state.items.find((function(t){return t._uuid===e}))}var U=function(e){function r(){var e;c(this,r);for(var t=arguments.length,n=new Array(t),o=0;o<t;o++)n[o]=arguments[o];return m(e=d(this,r,[].concat(n)),"bottomToolbar",void 0),m(e,"hiddenNodeId",""),m(e,"renderMode","tree"),m(e,"isFilter",_(!1)),e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&y(e,t)}(r,e),s(r,[{key:"onCreated",value:(k=u(i().mark((function e(){var t,n,o,a;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p(r,"onCreated",this,3)([]);case 2:n=(null===(t=this.view.model.viewLayoutPanel)||void 0===t?void 0:t.controls)||[],this.bottomToolbar=n.find((function(e){return"toolbar"===e.name})),o=this.model.controlParam.ctrlParams,(a=void 0===o?{}:o).HIDDENNODEID&&(this.hiddenNodeId=a.HIDDENNODEID),a.RENDERMODE&&(this.renderMode=a.RENDERMODE);case 7:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"initState",value:function(){p(r,"initState",this,3)([]),this.state.newingNodeModel=null,this.state.newingNodeText=null,this.state.newingNodeDefault=null,this.state.editingNodeKey=null,this.state.editingNodeText=null,this.state.editingNodeDefault=null}},{key:"onDataChange",value:function(e){}},{key:"initDropNodeRss",value:function(){var e,t=this;null===(e=this.model.detreeNodes)||void 0===e||e.forEach((function(e){if(e.allowDrop){var n=[];a(t.model,{parentId:e.id,hasQuery:!1}).forEach((function(e){var r;if(null!==(r=e.parentDER1N)&&void 0!==r&&r.pickupDEFName){var o=t.getNodeModel(e.childDETreeNodeId);"DE"===(null==o?void 0:o.treeNodeType)&&o.appDataEntityId&&n.push({minorEntityId:o.appDataEntityId,pickupDEFName:e.parentDER1N.pickupDEFName.toLowerCase(),childDETreeNodeId:e.childDETreeNodeId,detreeNodeRSParams:e.detreeNodeRSParams})}})),n.length>0&&t.dropNodeRss.set(e.id,n)}}))}},{key:"updateTreeNode",value:function(e){var t=e.nodeKey,n=e.defaultValue,r=!(!0!==this.context.srfreadonly&&"true"!==this.context.srfreadonly);if(t&&t!==this.state.editingNodeKey&&!r){var o=V(t,this),i=this.getNodeModel(o._nodeId);null!=i&&i.allowEditText&&(this.state.editingNodeKey=o._id,this.state.editingNodeText=o._text,this.state.editingNodeDefault=n,this.state.newingNodeModel=null,this.state.newingNodeText=null,this.state.newingNodeDefault=null)}}},{key:"removeTreeNode",value:function(e){if(e&&e!==this.state.editingNodeKey){var t=V(e,this),n={context:this.context||{},params:this.params||{},data:[t]};this.onRemoveTreeNode(n)}}},{key:"newTreeNode",value:function(e){var t=e.nodeType,n=e.defaultValue,r=void 0===n?{}:n,o=this.getNodeModel(t);this.state.newingNodeModel=o,this.state.newingNodeDefault=r,this.state.editingNodeKey=null,this.state.editingNodeText=null,this.state.editingNodeDefault=null}},{key:"createDeNodeData",value:(E=u(i().mark((function e(t){var n,r=this;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=ibiz.hub.getApp(this.context.srfappid),e.next=3,Promise.all(t.map(function(){var e=u(i().mark((function e(t){var o,a,u,c;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=r.getNodeModel(t._nodeId),a=t._deData,u=r.context.clone(),e.next=5,n.deService.exec(o.appDataEntityId,"create",u,a);case 5:c=e.sent,r.emitDEDataChange("create",c.data),c.data&&r.refresh();case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return E.apply(this,arguments)})},{key:"onCreateTreeNode",value:(D=u(i().mark((function e(){var t,n,r,o,a;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.state.newingNodeModel,n=t.textAppDEFieldId,r=t.id,o=this.state.newingNodeText,a={_deData:{}},Object.assign(a,{_nodeId:r,_text:o}),Object.assign(a._deData,m({},n,o)),this.state.newingNodeDefault&&Object.assign(a._deData,this.state.newingNodeDefault),Object.assign(a._deData,m({},n,o)),e.next=9,this.createDeNodeData([a]);case 9:this.state.newingNodeModel=null,this.state.newingNodeText=null,this.state.newingNodeDefault=null;case 12:case"end":return e.stop()}}),e,this)}))),function(){return D.apply(this,arguments)})},{key:"onModifyTreeNode",value:(N=u(i().mark((function e(t,n){var r,o,a=this;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=this.getNodeModel(t._nodeId)).allowEditText){e.next=3;break}throw new F(r,"树节点没有配置编辑模式：名称");case 3:if("DE"===t._nodeType){e.next=5;break}throw new B("不是实体树节点数据");case 5:if(t._text===n){e.next=10;break}return t._text=n,this.state.editingNodeDefault&&(o=Object.keys(this.state.editingNodeDefault))&&o.length>0&&o.forEach((function(e){z(t._deData[e])&&(t._deData[e]=a.state.editingNodeDefault[e])})),e.next=10,this.updateDeNodeData([t]);case 10:this.state.editingNodeKey=null,this.state.editingNodeText=null,this.state.editingNodeDefault=null;case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return N.apply(this,arguments)})},{key:"onRemoveTreeNode",value:(w=u(i().mark((function e(t){var n,r,o,a,c,s,d,f=this;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.handlerAbilityParams(t),r=n.context,o=n.params,a=n.data,c=this.getNodeModel(a[0]._nodeId),!0===(null==t?void 0:t.silent)){e.next=8;break}return e.next=5,ibiz.confirm.error({title:"数据删除",desc:"确认删除数据？"});case 5:if(e.sent){e.next=8;break}return e.abrupt("return");case 8:return e.next=10,this._evt.emit("onBeforeRemove",void 0);case 10:return e.next=12,this.startLoading();case 12:return s=!1,e.prev=13,d=l(c.appDataEntityId),e.next=17,h(a.map(function(){var e=u(i().mark((function e(t){var n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.srfuf===v.CREATE){e.next=8;break}return(n=r.clone())[d]=t.srfkey,e.next=5,ibiz.hub.getApp(c.appId).deService.exec(c.appDataEntityId,"remove",n,a,o);case 5:return e.next=7,e.sent;case 7:s=!0;case 8:f.afterRemove(t);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 17:if(!0!==(null==t?void 0:t.silent)&&this.actionNotification("REMOVESUCCESS",{data:a,default:"数据[".concat(a.map((function(e){return e.srfmajortext})).join("、"),"]删除成功!")}),!s||null!=t&&t.notRefresh){e.next=21;break}return e.next=21,this.refresh();case 21:e.next=29;break;case 23:return e.prev=23,e.t0=e.catch(13),e.next=27,this._evt.emit("onRemoveError",void 0);case 27:throw this.actionNotification("REMOVEERROR",{error:e.t0,data:a}),e.t0;case 29:return e.prev=29,e.next=32,this.endLoading();case 32:return e.finish(29);case 33:return this.state.selectedData=[],e.next=36,this._evt.emit("onRemoveSuccess",void 0);case 36:case"end":return e.stop()}}),e,this,[[13,23,29,33]])}))),function(e){return w.apply(this,arguments)})},{key:"calcAllowDrop",value:function(e,t,n){var r,o,i=this.getNodeModel(e._nodeId),a=this.getNodeModel(t._nodeId);if("inner"===n)return!!this.findDropNodeRS(t._nodeId,i.appDataEntityId);if(i.appDataEntityId!==a.appDataEntityId)return!1;if((null===(r=e._parent)||void 0===r?void 0:r._id)===(null===(o=t._parent)||void 0===o?void 0:o._id)){var u=this.getNodeModel(t._nodeId);return!0===(null==u?void 0:u.allowOrder)}if(!t._parent)return!1;if(t._parent&&t._parent._id&&this.getNodeModel(t._parent._nodeId).rootNode)return!0;return!!this.findDropNodeRS(t._parent._nodeId,i.appDataEntityId)}},{key:"onNodeDrop",value:(x=u(i().mark((function e(r,o,a){var u,c,s,d,f,p,h,v,y,m,g,b,x,w,N,_,D,E,k,I;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("inner"!==a||o._leaf||void 0!==o._children){e.next=3;break}return e.next=3,this.expandNodeByKey([o._id]);case 3:if(s=this.getNodeModel(r._nodeId),d="inner"===a?o:o._parent,f="inner"===a||(null===(u=o._parent)||void 0===u?void 0:u._id)!==(null===(c=r._parent)||void 0===c?void 0:c._id),p=this.getNodeModel(o._nodeId),h=s.appDataEntityId!==p.appDataEntityId,v=!1,this.getNodeModel(d._nodeId).rootNode&&(v=!0),!f&&!v){e.next=19;break}y=[],m=n(this.dropNodeRss.values());try{for(m.s();!(g=m.n()).done;)b=g.value,y.push.apply(y,t(b.filter((function(e){return e.minorEntityId===s.appDataEntityId}))))}catch(i){m.e(i)}finally{m.f()}return v&&f?y&&(y.forEach((function(e){r._deData[e.pickupDEFName]=null})),p=this.getNodeModel(s.id)):(x=this.findDropNodeRS(d._nodeId,s.appDataEntityId))&&(y&&y.forEach((function(e){r._deData[e.pickupDEFName]=null})),r._deData[x.pickupDEFName]=d._value,x.detreeNodeRSParams&&x.detreeNodeRSParams.forEach((function(e){var t,n;e.name&&e.value&&null!==(t=r._deData)&&void 0!==t&&t.hasOwnProperty(e.name.toLowerCase())&&null!==(n=d._deData)&&void 0!==n&&n.hasOwnProperty(e.value.toLowerCase())&&(r._deData[e.name.toLowerCase()]=d._deData[e.value.toLowerCase()])})),p=this.getNodeModel(x.childDETreeNodeId)),this.state.expandedKeys=this.calcExpandedKeys([d]),e.next=19,this.updateDeNodeData([r]);case 19:if("inner"!==a&&!h){e.next=27;break}if(!f){e.next=23;break}return e.next=23,this.refreshNodeChildren(r,!0);case 23:return e.next=25,this.refreshNodeChildren(d,!0);case 25:e.next=46;break;case 27:if(N=(w=p).moveAppDEActionId,_=w.appDataEntityId,!w.allowOrder){e.next=46;break}if(N){e.next=31;break}throw new F(this.model,ibiz.i18n.t("runtime.controller.common.md.noMoveDataCconfig"));case 31:return D={srftargetkey:o.srfkey,srfmovetype:"prev"===a?"MOVEBEFORE":"MOVEAFTER"},E=ibiz.hub.getApp(this.context.srfappid),k=l(_),(I=this.context.clone())[k]=r.srfkey,e.next=38,E.deService.exec(_,N,I,D);case 38:if(!e.sent.ok){e.next=46;break}if(this.emitDEDataChange("update",r._deData),!f){e.next=44;break}return e.next=44,this.refreshNodeChildren(r,!0);case 44:return e.next=46,this.refreshNodeChildren(d);case 46:this.state.selectedData=[];case 47:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return x.apply(this,arguments)})},{key:"onDEDataChange",value:function(e){var t=this;if(e.triggerKey!==this.triggerKey){var n=e.data;if("OBJECTCREATED"!==e.subtype){var r=this.state.items.find((function(e){return"DE"===e._nodeType&&e._deData&&e._deData.srfdecodename===n.srfdecodename&&e._deData.srfkey===n.srfkey}));r&&this.doNextActive((function(){return t.refreshNodeChildren(r,!0)}),{key:"refresh".concat(r._id)})}else{var o;(null===(o=this.model.detreeNodes)||void 0===o?void 0:o.find((function(e){if(e.appDataEntityId){var t=l(e.appDataEntityId);if(n.srfdecodename===t)return!0}return!1})))&&this.refresh()}}}},{key:"afterLoad",value:(b=u(i().mark((function e(t,n){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",p(r,"afterLoad",this,3)([t,n]));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return b.apply(this,arguments)})},{key:"onTreeNodeClick",value:(g=u(i().mark((function e(t,n){var r,o,a;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(o=null===(r=this.contextMenuInfos[t._nodeId])||void 0===r?void 0:r.clickTBUIActionItem)){e.next=3;break}return e.abrupt("return",this.doUIAction(o.uiactionId,t,n,o.appId));case 3:if(!this.state.navigational){e.next=7;break}if(null!=(a=this.getNodeModel(t._nodeId))&&a.navAppViewId){e.next=7;break}return e.abrupt("return");case 7:if(this.state.singleSelect&&!t._disableSelect&&this.setSelection([t]),1!==this.state.mdctrlActiveMode){e.next=11;break}return e.next=11,this.setActive(t);case 11:case"end":return e.stop()}}),e,this)}))),function(e,t){return g.apply(this,arguments)})},{key:"changeTreeState",value:(f=u(i().mark((function e(t){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t&&"draft"===t?(this.isFilter.value=!0,this.evt.emit("onFilterNode",{nodeTag:t})):this.resetTreeState();case 1:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"resetTreeState",value:function(){this.isFilter.value&&(this.evt.emit("onResetSate",{}),this.isFilter.value=!1)}},{key:"refresh",value:(o=u(i().mark((function e(){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:p(r,"refresh",this,3)([]),this.resetTreeState();case 2:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})}]);var o,f,g,b,x,w,N,D,E,k}(o);var G=D({name:"IBizGroupTreeControl",props:{modelData:{type:Object,required:!0},context:{type:Object,required:!0},params:{type:Object,default:function(){return{}}},provider:{type:Object},mdctrlActiveMode:{type:Number,default:void 0},singleSelect:{type:Boolean,default:void 0},navigational:{type:Boolean,default:void 0},defaultExpandedKeys:{type:Array},loadDefault:{type:Boolean,default:!0}},setup:function(){var e=x((function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e,t,n){if(f())return Reflect.construct.apply(null,arguments);var r=[null];r.push.apply(r,t);var o=new(e.bind.apply(e,r));return n&&y(o,n.prototype),o}(U,t)})),t=E((function(){return!(!0!==e.context.srfreadonly&&"true"!==e.context.srfreadonly)})),n=k({});e.evt.on("onCreated",(function(){e.counter&&e.counter.onChange((function(e){Object.assign(n,e)}),!0)}));var o=w("control-group-tree"),a=w("control-".concat(e.model.controlType.toLowerCase())),c=_(null),l=_(null),s=_(""),d=_(null);I((function(){return d.value}),(function(e){e&&e.$el.getElementsByTagName("input")[0].focus()}));var p=function(){var t=u(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.state.editingNodeKey){t.next=8;break}if(!e.state.editingNodeText){t.next=7;break}return n=V(e.state.editingNodeKey,e),t.next=5,e.onModifyTreeNode(n,e.state.editingNodeText);case 5:t.next=8;break;case 7:e.state.editingNodeKey=null;case 8:e.state.newingNodeText?e.onCreateTreeNode():e.state.newingNodeModel=null;case 9:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),h=function(){var t=u(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.state.editingNodeKey&&(e.state.editingNodeKey=null),e.state.newingNodeModel&&(e.state.newingNodeModel=null,e.state.newingNodeText="");case 2:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),v=function(e,t){var n=function(){var t=e.value;if(!t)throw new B("找不到el-tree实例对象");return t},r=function(){var n,o=e.value;o?(Object.values(o.store.nodesMap).forEach((function(e){var n=t.state.expandedKeys.includes(e.data._id);n!==e.expanded&&(n?e.expand():e.collapse())})),t.state.singleSelect?e.value.setCurrentKey((null===(n=t.state.selectedData[0])||void 0===n?void 0:n._id)||void 0):o.setCheckedKeys(t.state.selectedData.map((function(e){return e._id})))):setTimeout((function(){r()}),200)},o=K(r,500);return{getTreeInstance:n,updateUI:o,triggerNodeExpand:function(e){var t=n(),r=null==t?void 0:t.store.nodesMap[e];if(r)return r.expanded?(r.collapse(),!1):(r.expand(),!0)}}}(c,e),m=v.updateUI,b=v.triggerNodeExpand,N=function(e){return e.map((function(e){return{_id:e._id,_uuid:e._uuid,_leaf:e._leaf,_text:e._text}}))};e.evt.on("onAfterRefreshParent",(function(e){if(c.value){var t=e.parentNode,n=e.children,r=N(n);c.value.updateKeyChildren(t._id,r),m()}})),e.evt.on("onAfterNodeDrop",(function(e){e.isChangedParent&&(s.value=P())}));var D=E((function(){return e.state.isLoaded?e.model.rootVisible?e.state.rootNodes:e.state.rootNodes.reduce((function(e,t){return t._children?e.concat(t._children):e}),[]):[]}));I(D,(function(e,t){e!==t&&(s.value=P())}));var M=function(){var t=u(i().mark((function t(n,r){var o,a;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==n.level){t.next=5;break}o=D.value,ibiz.log.debug("初始加载"),t.next=15;break;case 5:if(!(a=V(n.data._uuid,e))._children){t.next=11;break}ibiz.log.debug("节点展开加载-本地",a),o=a._children,t.next=15;break;case 11:return ibiz.log.debug("节点展开加载-远程",a),t.next=14,e.loadNodes(a);case 14:o=t.sent;case 15:ibiz.log.debug("给树返回值",o),r(N(o)),m();case 18:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}(),L=!1;e.evt.on("onLoadSuccess",(function(){L=!0,setTimeout((function(){L=!1}),200)})),e.evt.on("onSelectionChange",u(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!L){t.next=3;break}return t.next=3,T();case 3:e.state.singleSelect?c.value.setCurrentKey((null===(n=e.state.selectedData[0])||void 0===n?void 0:n._id)||void 0):c.value.setCheckedKeys(e.state.selectedData.map((function(e){return e._id})));case 4:case"end":return t.stop()}}),t)}))));var j,F=function(t,n){var r=n.checkedNodes;e.setSelection(r)},G=!1,q=function(n,r){var o;if(r.stopPropagation(),!n._disableSelect&&!G){if((null===(o=c.value)||void 0===o?void 0:o.getCurrentKey())===n._id&&!t.value){var i,a=null===(i=c.value)||void 0===i?void 0:i.getCurrentKey();e.updateTreeNode({nodeKey:a,defaultValue:{}})}var u;if(!e.state.singleSelect)null===(u=c.value)||void 0===u||u.setCurrentKey(n._id);if(e.state.navigational){var l=e.getNodeModel(n._nodeId);if(null==l||!l.navAppViewId){var s=b(n._id);e.onExpandChange(n,s)}}e.onTreeNodeClick(n,r),G=!0,setTimeout((function(){G=!1}),200)}},H=function(t,n){n.stopPropagation(),t._disableSelect||e.onDbTreeNodeClick(t)};e.evt.on("onMounted",(function(){if(Object.values(e.contextMenus).length>0){r.import("@imengyu/vue3-context-menu").then((function(e){(j=e.default).default&&!j.showContextMenu&&(j=j.default)}))}}));var $=C("IBizRawItem"),Q=C("IBizIcon"),Y=function(t,n,r,o){var i=[];return t.forEach((function(t){if("SEPERATOR"!==t.itemType){var a=o[t.id];if((!a||a.visible)&&!(t.actionLevel>100)){var u={};if(t.showCaption&&t.caption&&(u.label=t.caption),t.sysImage&&t.showIcon&&(u.icon=R(Q,{icon:t.sysImage},null)),"DEUIACTION"===t.itemType){u.disabled=a.disabled,u.clickClose=!0;var c=t.uiactionId;c&&(u.onClick=function(){e.doUIAction(c,n,r,t.appId)})}else if("RAWITEM"===t.itemType){t.rawItem&&(u.label=R($,{rawItem:t},null))}else if("ITEMS"===t.itemType){var l;null!==(l=t.detoolbarItems)&&void 0!==l&&l.length&&(u.children=Y(t.detoolbarItems,n,r,o))}i.push(u)}}else i.push({divided:"self"})})),i},J=function(){var t=u(i().mark((function t(n,r){var a,u,c,l;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r.preventDefault(),r.stopPropagation(),null!=(a=e.getNodeModel(n._nodeId))&&a.decontextMenu){t.next=5;break}return t.abrupt("return");case 5:if((u=e.contextMenus[a.decontextMenu.id]).model.detoolbarItems){t.next=8;break}return t.abrupt("return");case 8:return t.next=10,u.calcButtonState(n._deData||(n.srfkey?n:void 0),a.appDataEntityId);case 10:if(c=u.state.buttonsState,(l=Y(u.model.detoolbarItems,n,r,c)).length){t.next=14;break}return t.abrupt("return");case 14:j.showContextMenu({x:r.x,y:r.y,customClass:o.b("context-menu"),items:l});case 15:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}(),W=function(t,n){var r;if(null!=t&&null!==(r=t.decontextMenu)&&void 0!==r&&null!==(r=r.detoolbarItems)&&void 0!==r&&r.length){var o=e.contextMenuInfos[t.id];return o.clickTBUIActionItem&&o.onlyOneActionItem?null:R(C("iBizContextMenuControl"),{modelData:t.decontextMenu,groupLevelKeys:[50,100],nodeModel:t,nodeData:n,context:e.context,onActionClick:function(t,r){return e.doUIAction(t.uiactionId,n,r,t.appId)}},null)}},X=function(t,n){var r=V(t._uuid,e);if(!r)throw new B("没有找到_uuid为".concat(t._uuid,"的节点"));e.onExpandChange(r,n)},Z=K((function(){e.load()}),500),ee=function(t,n,r){var o=V(t.data._uuid,e),i=V(n.data._uuid,e);return e.calcAllowDrop(o,i,r)},te=function(t){var n=V(t.data._uuid,e);return e.calcAllowDrag(n)},ne=function(t,n,r){var o=function(e){switch(e){case"inner":return"inner";case"before":return"prev";case"after":return"next";default:throw new B("暂不支持dropType:".concat(e))}}(r),i=V(t.data._uuid,e),a=V(n.data._uuid,e);e.onNodeDrop(i,a,o)},re=function(e){"Enter"!==e.key&&13!==e.keyCode||(e.stopPropagation(),p()),"Escape"!==e.key&&27!==e.keyCode||(e.stopPropagation(),h())},oe=function(t){if("F2"===t.code||"Enter"===t.code){var n,r=null===(n=c.value)||void 0===n?void 0:n.getCurrentKey();e.updateTreeNode(r)}},ie=function(){var t=u(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.evt.emit("onBack",{}),e.isFilter.value=!1,c.value&&c.value.filter("");case 3:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();S((function(){var t;null===(t=l.value)||void 0===t||t.$el.addEventListener("keydown",oe),e.evt.on("onFilterNode",function(){var t=u(i().mark((function t(n){var r;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:(r=n.nodeTag)&&(e.isFilter.value=!0),c.value&&c.value.filter("".concat(r,"@"));case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),e.evt.on("onResetSate",u(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.evt.emit("onBack",{}),e.isFilter.value=!1,c.value&&c.value.filter("");case 3:case"end":return t.stop()}}),t)})))),e.evt.on("onLoadSuccess",(function(){e.isFilter.value?e.evt.emit("onFilterNode",{nodeTag:"draft"}):e.evt.emit("onResetSate",{})}))})),O((function(){var e;null===(e=l.value)||void 0===e||e.$el.removeEventListener("keydown",oe)}));var ae=function(e,t){return(t._id||"").includes(e)},ue=function(e){return"root:draft_parent"===e._id?"draft_parent":null},ce=function(e){if(e.counterId){var t=n[e.counterId];return z(t)||1===e.counterMode&&0===t?null:R("div",{class:o.em("counter","box")},[R("span",{class:o.e("dot")},[A("·")]),R(C("iBizBadge"),{class:o.e("counter"),value:t},null)])}},le=function(t){var n,r;if(!e.state.newingNodeModel)return null;var i=(e.state.newingNodeDefault||{}).parent_id;if(i){if(!t)return null;if((t||{})._value!==i)return null}return!i&&t?null:R("div",{class:[o.be("node","newing")]},[null!==(n=e.state.newingNodeModel)&&void 0!==n&&n.sysImage?R(Q,{class:o.be("node","icon"),icon:null===(r=e.state.newingNodeModel)||void 0===r?void 0:r.sysImage},null):null,R(C("el-input"),{modelValue:e.state.newingNodeText,"onUpdate:modelValue":function(t){return e.state.newingNodeText=t},ref:"treeNodeTextInputRef",class:o.b("editing-node"),onBlur:p,onKeydown:function(e){re(e)}},null)])};return{c:e,ns:o,treeRef:c,treeviewRef:l,treeNodeTextInputRef:d,treeData:D,treeRefreshKey:s,findNodeData:V,handleEditKeyDown:re,onCheck:F,onNodeClick:q,onNodeDbClick:H,onNodeContextmenu:J,loadData:M,renderContextMenu:W,renderCounter:ce,updateNodeExpand:X,onInput:function(t){e.state.query=t,Z()},allowDrop:ee,allowDrag:te,handleDrop:ne,onNodeTextEditBlur:p,renderTree:function(){return R("div",{class:[o.b("content"),o.is("filter",e.isFilter.value)]},[e.isFilter.value?R("div",{class:o.b("filter")},[R("div",{class:o.be("filter","header"),onClick:ie},[R(C("ion-icon"),{name:"arrow-back-outline"},null),A("返回")])]):null,R("div",{class:[o.b("tree-box"),o.is("filter",e.isFilter.value)]},[R(C("el-tree"),{ref:"treeRef",key:s.value,class:[a.b("tree"),o.is("list-tree","listTree"===e.renderMode)],"node-key":"_id","highlight-current":!0,"expand-on-click-node":!1,"auto-expand-parent":!1,"show-checkbox":!e.state.singleSelect,"check-strictly":!0,"default-expanded-keys":e.state.expandedKeys,props:{label:"_text",children:"_children",isLeaf:"_leaf",class:ue},lazy:!0,load:M,onCheck:F,onNodeExpand:function(e){X(e,!0)},onNodeCollapse:function(e){X(e,!1)},draggable:!t.value,"allow-drop":ee,"allow-drag":te,onNodeDrop:ne,"filter-node-method":ae},{default:function(n){var r,i=V(n.data._uuid,e);if(!i)return null;var a,u=e.getNodeModel(i._nodeId);if(e.state.editingNodeKey===i._id&&!t.value)return R("div",{class:[o.b("node"),null===(a=u.sysCss)||void 0===a?void 0:a.cssName]},[i._icon?R(Q,{class:o.be("node","icon"),icon:i._icon},null):null,R(C("el-input"),{modelValue:e.state.editingNodeText,"onUpdate:modelValue":function(t){return e.state.editingNodeText=t},ref:"treeNodeTextInputRef",class:o.b("editing-node"),onBlur:function(){p()},onKeydown:function(e){re(e)}},null)]);var c,l=g(u);return c=l?R(C("iBizControlShell"),{data:i,modelData:l,context:e.context,params:e.params},null):[i._icon?R(Q,{class:o.be("node","icon"),icon:i._icon},null):null,i._textHtml?R("span",{class:o.be("node","label"),innerHTML:i._textHtml},null):R("span",{class:o.be("node","label")},[i._text])],[R("div",{onDblclick:function(e){return H(i,e)},onClick:function(e){return q(i,e)},onContextmenu:function(e){return J(i,e)},class:[o.b("node"),o.is("hidden",Object.is(e.hiddenNodeId,i._nodeId)&&!e.isFilter.value),i._leaf?o.be("node","item"):o.be("node","group"),null===(r=u.sysCss)||void 0===r?void 0:r.cssName]},[c,ce(u),W(u,i)]),le(i)]}}),le()])])}}},render:function(){var e=this,t={searchbar:function(){return e.c.enableQuickSearch?R(C("el-input"),{"model-value":e.c.state.query,class:e.ns.b("quick-search"),placeholder:e.c.state.placeHolder,onInput:e.onInput},{prefix:function(){return R(C("ion-icon"),{class:e.ns.e("search-icon"),name:"search"},null)}}):null}};this.c.bottomToolbar&&(t.toolbar=function(){return R(C("iBizControlShell"),{modelData:e.c.bottomToolbar,context:e.c.context,params:e.c.params},null)});var n,r=this.c.controlPanel?"tree":"default";return t[r]=function(){if(e.c.state.isLoaded&&e.treeRefreshKey)return e.renderTree()},M(R(C("iBizControlBase"),{ref:"treeviewRef",controller:this.c},"function"==typeof(n=t)||"[object Object]"===Object.prototype.toString.call(n)&&!j(n)?t:{default:function(){return[t]}}),[[L("loading"),this.c.state.isLoading]])}}),q=s((function e(){c(this,e),m(this,"component","IBizGroupTreeControl")})),H=N(G,(function(e){e.component(G.name,G),b("TREE_RENDER_GROUP_TREE",(function(){return new q}))}));e({IBizGroupTreeControl:H,default:H})}}}))}();
